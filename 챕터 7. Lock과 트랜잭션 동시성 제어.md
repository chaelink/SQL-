### 챕터 7. Lock과 트랜잭션 동시성 제어

### 1절 Lock

- db 모니터링 과정에 락이 나타나는 건 자연스러운 현상이다
- db 모니터링 과정에 블로킹이 자주 나타나는 건 좋지 않은 현상이다
- lock에 의해 발생하는 문제를 해결하는 가장 효과적인 방법은 sql을 튜닝해서 io를 줄이는 것이다
- 데드락이 발생하면, dbms가 둘 중 한 세션에 에러를 발생시킴으로써 교착 상태를 해소한다
- 원자성을 해치지 않는 선에서 트랜잭션은 가능한 짧게 정의하는 것이 좋다

- 논리적, db 전체, 래치보다 강력

<br>

- 배타적 Lock
  - 데이터를 변경(INSERT, UPDATE, DELETE)할 때 사용 DML
  - 해당 데이터에 대해 다른 락(S 또는 X)을 허용하지 않아 혼자서만 데이터를 변경
  - 모든 DBMS가 DML 수행 시 배타적 Lock 사용
  - 서로 다른 컬럼을 Update 하더라도 Lock 경합을 피할 수 없음
- 공유 Lock
  - 데이터를 읽을 때 사용합니다. 여러 세션이 동시에 데이터를 읽을 수 있지만, 데이터를 변경할 수는 없음
  - SQL Server는 SELECT문으로 데이터를 읽을 때 공유 Lock 사용

<br>

- **SQL SERVER**
  - 테이블에 인덱스나 제약 조건이 없으면, INSERT 끼리는 서로 블로킹하지 않음(동시 사용 가능)
  - SQL Server는 SELECT문으로 데이터를 읽을 때 공유 Lock 사용
  - 다른 트랜잭션이 조회 중인 레코드를 읽을 때는 기다리지 않아도 된다(공유 락끼리는 같이 사용 가능)
  - 변경하는 데이터가 많아지면 Lock Escalation 이 발생한다
  - 다른 트랜잭션이 조회 중인 레코드를 변경하려면, 다음 레코드로 이동할 때까지만 기다리면 된다
- **오라클**
  - MVCC 모델을 사용하는 오라클은 SELECT문 수행 시 어떤 Lock도 사용하지 않음
  - 따라서, 다른 트랜잭션이 변경 중인 레코드를 읽어야 할 때 기다리지 않고, UNDO에서 변경 이전 값을 찾아서 읽음 

<br>

- Lock Escalation : 로우 레벨 락이 페이지, 익스텐트, 테이블 레벨 락으로 점점 화장되는 것
  - 오라클은 락을 로우 자체의 속성으로 관리하므로 Lock Escalation 이 절대 발생하지 않음 
- Lock Extension
- Lock Expansion
- Lock Enforcement

<br>

- 오라클 테이블 Lock
  - 사용 이유 : 사용자가 데이터를 갱신(DML)하는 도중에 DBA가 테이블 구조를 변경(DDL)하면 안되기 때문에 

<br>

- TM lock
- TX Lock


### 2절 트랜잭션
- 트랜잭션 격리 단계
- 트랜잭션 격리 수준 별 발생 문제


### 3절 동시성 제어
- 트랜잭션 격리성 수준을 상향 조정하면, 일관성은 좋아지고 동시성은 나빠짐
- MVCC 모델을 사용하는 DBMS에서는, 격리성 수준을 상향 조정하더라도 동시성이 나빠지지 않음

<br>

- 낙관적 동시성 제어
  - 데이터를 읽는 시점부터 아예 lock을 설정
- 비관적 동시성 제어
  - 데이터를 읽는 시점에는 lock을 설정하지 않음
  - 이후에 같은 데이터를 읽거나 변경할 때는 반드시 변경 여부를 확인해야 함 

<br>

- SELECT FOR UPDATE 문
  - WAIT 옵션 : 데이터베이스에서 락(Lock)이 걸린 행을 조회할 때, 무작정 대기하지 않고 지정한 시간(초 단위) 동안만 락 해제를 기다린 후 실패 시 에러를 반환하는 옵션
  - NO WAIT 옵션 : 대상 행이 다른 트랜잭션에 의해 이미 잠금(Lock) 상태일 때, 대기(Wait)하지 않고 즉시 오류(Error)를 발생시켜 애플리케이션에 제어권을 반환

<BR>

- 동시성 향상 방법
  - 트랜잭션 격리성 수준 상향은 동시성 향상하진 않음
    


<br>

- 오라클 MVCC의 Snapshot too old(ORA-01555) 에러



---
### 헷갈리는 내용
- TM lock, TX Lock 이 무어냐...
- 각 트랜잭션 격리, 격리 수준 문제 이해하기
- 오라클 MVCC의 장단점, Snapshot too old(ORA-01555) 에러



















